<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­å€‰å„²ç³»çµ± - å¤šäººå…±äº«ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f4f7f6; }
        .nav-header { background: #2c3e50; color: white; padding: 15px 0; margin-bottom: 20px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        /* åº«å­˜ä½æ–¼é–€æª»çš„ç´…ç‡ˆæ¨£å¼ */
        .low-stock { background-color: #ffdddd !important; color: #d9534f; font-weight: bold; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay"><div class="spinner-border text-primary"></div></div>

<div class="nav-header"><div class="container d-flex justify-content-between">
    <h4 class="m-0">ğŸ“¦ æ¡ˆå ´é€²å‡ºè²¨ç®¡ç†ç³»çµ±</h4>
    <button class="btn btn-outline-light btn-sm" onclick="fetchData()">ğŸ”„ åŒæ­¥é›²ç«¯è³‡æ–™</button>
</div></div>

<div class="container">
    <div class="row">
        <div class="col-md-4">
            <div class="card p-3">
                <h6 class="fw-bold">ğŸ–Šï¸ æ–°å¢ç•°å‹•</h6>
                <form id="wmsForm" class="small">
                    <div class="mb-2">æ—¥æœŸ<input type="date" id="date" class="form-control form-control-sm" required></div>
                    <div class="mb-2">å“é …<input type="text" id="itemName" class="form-control form-control-sm" required></div>
                    <div class="mb-2">æ•¸é‡ (å‡ºè²¨è² æ•¸)<input type="number" id="qty" class="form-control form-control-sm" required></div>
                    <div class="mb-2">å–®åƒ¹<input type="number" id="price" class="form-control form-control-sm" required></div>
                    <div class="mb-2">æ¡ˆå ´/åœ°é»<input type="text" id="loc" class="form-control form-control-sm" required></div>
                    <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">æäº¤</button>
                </form>
            </div>
            <div class="card p-3">
                <h6 class="fw-bold">ğŸ“Š Excel å ±è¡¨</h6>
                <select id="exportLocSelect" class="form-select form-select-sm mb-2"><option value="ALL">-- å…¨éƒ¨æ¡ˆå ´ --</option></select>
                <button class="btn btn-success btn-sm w-100" onclick="exportToExcel()">æŒ‰æ¡ˆå ´åŒ¯å‡ºç´€éŒ„</button>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card p-3">
                <h6 class="fw-bold">ğŸ“ ç•¶å‰åº«å­˜å½™æ•´ (é–€æª»: 30)</h6>
                <table class="table table-sm table-hover border">
                    <thead class="table-light"><tr><th>å“é …</th><th>ç´¯è¨ˆé€²</th><th>ç´¯è¨ˆå‡º</th><th>å‰©é¤˜</th><th>è³‡ç”¢</th></tr></thead>
                    <tbody id="inventoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBuPn8KchD0b8YsvxZ9tYbbS54DpZVuNjbaB6ffkFNEo3oJbhDEktKmieuz3dLKKkS7Q/exec"; 
    const LOW_STOCK_LEVEL = 30; // ğŸ‘ˆ åœ¨é€™è£¡æ§åˆ¶ç´…ç‡ˆé–€æª»æ•¸å­—
    let allData = [];

    document.getElementById('date').valueAsDate = new Date();

    async function fetchData() {
        showLoader(true);
        try {
            const res = await fetch(SCRIPT_URL);
            allData = await res.json();
            renderAll();
        } catch (e) { alert("é€£ç·šå¤±æ•—"); }
        showLoader(false);
    }

    document.getElementById('wmsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoader(true);
        const payload = {
            date: document.getElementById('date').value,
            name: document.getElementById('itemName').value,
            quantity: parseInt(document.getElementById('qty').value),
            price: parseFloat(document.getElementById('price').value),
            location: document.getElementById('loc').value
        };
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        e.target.reset();
        document.getElementById('date').valueAsDate = new Date();
        await fetchData();
    });

    function renderAll() {
        const inv = {};
        const locs = new Set();
        allData.forEach(r => {
            const [date, name, qty, price, loc] = r;
            locs.add(loc);
            if (!inv[name]) inv[name] = { in: 0, out: 0, lastPrice: price };
            if (qty > 0) inv[name].in += qty; else inv[name].out += Math.abs(qty);
            inv[name].lastPrice = price;
        });

        // æ¸²æŸ“è¡¨æ ¼ä¸¦åˆ¤æ–·ç´…ç‡ˆ
        const body = document.getElementById('inventoryBody');
        body.innerHTML = Object.entries(inv).map(([name, s]) => {
            const bal = s.in - s.out;
            // åˆ¤æ–·æ˜¯å¦ä½æ–¼é–€æª» 30
            const rowClass = bal < LOW_STOCK_LEVEL ? 'low-stock' : '';
            return `<tr class="${rowClass}">
                <td>${name} ${bal < LOW_STOCK_LEVEL ? 'âš ï¸' : ''}</td>
                <td>${s.in}</td><td>${s.out}</td>
                <td>${bal}</td><td>$${(bal * s.lastPrice).toLocaleString()}</td>
            </tr>`;
        }).join('');

        const select = document.getElementById('exportLocSelect');
        const cur = select.value;
        select.innerHTML = '<option value="ALL">-- å…¨éƒ¨æ¡ˆå ´ --</option>';
        Array.from(locs).sort().forEach(l => select.innerHTML += `<option value="${l}">${l}</option>`);
        select.value = cur;
    }

    function exportToExcel() {
        const loc = document.getElementById('exportLocSelect').value;
        const data = allData.filter(r => loc === "ALL" || r[4] === loc);
        const ws = XLSX.utils.aoa_to_sheet([["æ—¥æœŸ","å“é …","æ•¸é‡","å–®åƒ¹","æ¡ˆå ´"], ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Records");
        XLSX.writeFile(wb, `å ±è¡¨_${loc}.xlsx`);
    }

    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    fetchData();
</script>
</body>

</html>
