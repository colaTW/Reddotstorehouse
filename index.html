<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿å¾·è³‡è¨Šå°ˆæ¥­å€‰å„²ç³»çµ± v6.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: "Microsoft JhengHei", sans-serif; }
        .nav-header { background: #2c3e50; color: white; padding: 12px 0; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* é€²å‡ºè²¨æ¨¡å¼æ¨£å¼ */
        .form-inbound { border: 3px solid #28a745 !important; }
        .form-outbound { border: 3px solid #dc3545 !important; }
        
        /* åº«å­˜è­¦ç¤ºæ¨£å¼ (é‡è¦) */
        .low-stock { background-color: #fff1f0 !important; color: #cf1322; font-weight: bold; }
        .low-stock td { background-color: #fff1f0 !important; } /* å¼·åˆ¶è¦†è“‹ Bootstrap æ¨£å¼ */

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; }
        .btn-xs { padding: 2px 6px; font-size: 11px; }
        .price-info { font-size: 0.75rem; color: #666; margin-top: 4px; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay"><div class="spinner-border text-primary"></div></div>

<div class="nav-header">
    <div class="container d-flex justify-content-between align-items-center">
        <h5 class="m-0">ğŸ“¦ å°ˆæ¥­å€‰å„²ç®¡ç†ç³»çµ±</h5>
        <button class="btn btn-outline-light btn-sm" onclick="fetchData()">ğŸ”„ åŒæ­¥è³‡æ–™</button>
    </div>
</div>

<div class="container mt-3">
    <ul class="nav nav-pills mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab1">é€²å‡ºè²¨ä½œæ¥­</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab2">åŸºç¤è³‡æ–™è¨­å®š</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab3">æ¡ˆå ´å ±è¡¨</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab1">
            <div class="row">
                <div class="col-md-4">
                    <div id="formCard" class="card p-3 form-inbound">
                        <div class="d-flex mb-3">
                            <button id="btnIn" class="btn btn-success btn-sm w-50 me-1" onclick="switchMode('in')">åˆ‡æ›å…¥åº«</button>
                            <button id="btnOut" class="btn btn-outline-danger btn-sm w-50" onclick="switchMode('out')">åˆ‡æ›å‡ºåº«</button>
                        </div>
                        <h6 id="formTitle" class="fw-bold text-success">ğŸ“— å…¥åº«ç™»éŒ„</h6>
                        <form id="wmsForm">
                            <div class="mb-2 small">æ—¥æœŸæ™‚é–“<input type="datetime-local" id="datetime" class="form-control form-control-sm" required></div>
                            <div class="mb-2 small">å“é …<select id="itemSelect" class="form-select form-select-sm" required onchange="updatePrice()"></select></div>
                            <div class="mb-2 small">æ•¸é‡ (è«‹å¡«æ­£æ•¸)<input type="number" id="qty" class="form-control form-control-sm" required></div>
                            <div class="mb-2 small">å–®åƒ¹<input type="number" id="price" class="form-control form-control-sm" required><div id="priceHint" class="price-info"></div></div>
                            <div class="mb-2 small">å°è±¡/æ¡ˆå ´<select id="siteSelect" class="form-select form-select-sm"></select></div>
                            <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">ç¢ºèªæäº¤</button>
                        </form>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card p-3">
                        <div class="d-flex justify-content-between mb-2 align-items-center">
                            <h6 class="fw-bold m-0">ğŸ“ åº«å­˜æ¸…å–® (ä½æ–¼ 30 è­¦ç¤º)</h6>
                            <input type="text" id="searchInput" class="form-control form-control-sm w-50" placeholder="ğŸ” æœå°‹å“é …..." oninput="renderInventory()">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm small table-hover border">
                                <thead class="table-light"><tr><th>å“é …</th><th>é€²</th><th>å‡º</th><th>å‰©é¤˜</th><th>å–®åƒ¹</th><th>æ“ä½œ</th></tr></thead>
                                <tbody id="inventoryBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab2">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-3">
                        <h6 class="fw-bold border-bottom pb-2">ğŸ› ï¸ å“é …ç®¡ç†</h6>
                        <div class="input-group mb-2">
                            <input type="text" id="newItem" class="form-control form-control-sm" placeholder="æ–°ç·¨è™Ÿ/åç¨±">
                            <button class="btn btn-dark btn-sm" onclick="manageBasicData('Items', 'add', 'newItem')">æ–°å¢</button>
                        </div>
                        <ul id="itemList" class="list-group list-group-flush small"></ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-3">
                        <h6 class="fw-bold border-bottom pb-2">ğŸ› ï¸ æ¡ˆå ´ç®¡ç†</h6>
                        <div class="input-group mb-2">
                            <input type="text" id="newSite" class="form-control form-control-sm" placeholder="æ–°æ¡ˆå ´åç¨±">
                            <button class="btn btn-dark btn-sm" onclick="manageBasicData('Sites', 'add', 'newSite')">æ–°å¢</button>
                        </div>
                        <ul id="siteList" class="list-group list-group-flush small"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab3">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold m-0">ğŸ“Š æ¡ˆå ´å‡ºè²¨ç¸½è¦½</h6>
                    <button class="btn btn-success btn-sm" onclick="exportExcel()">ğŸ“¥ ä¸‹è¼‰ Excel</button>
                </div>
                
                <div class="mb-3">
                    <label class="small text-muted">è«‹é¸æ“‡è¦æª¢è¦–çš„æ¡ˆå ´ï¼š</label>
                    <select id="exportSite" class="form-select" onchange="renderSiteReport()"></select>
                </div>

                <div class="border rounded p-3 bg-light">
                    <div id="reportSummary" class="h5 text-primary fw-bold mb-3">è«‹é¸æ“‡æ¡ˆå ´ä»¥æª¢è¦–è³‡æ–™</div>
                    <table class="table table-sm small table-bordered bg-white">
                        <thead class="table-secondary"><tr><th>æ—¥æœŸ</th><th>å“é …</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å°è¨ˆ</th></tr></thead>
                        <tbody id="reportPreviewBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle">æ˜ç´°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <table class="table table-sm small mb-0 table-striped">
                    <thead class="table-dark"><tr><th>æ—¥æœŸæ™‚é–“</th><th>å‹•ä½œ</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>æ¡ˆå ´</th></tr></thead>
                    <tbody id="detailBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline-success btn-sm" onclick="exportSingleItemExcel()">åŒ¯å‡ºæ­¤å“é …æ˜ç´°</button>
                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrMGc7PAWLEateQ4XqBYCI-N_YQbotpY-yJxgX-QcLqFvZE06rwPsagQTxv_8lk_kG/exec"; // ğŸ‘ˆ è«‹æ›æˆä½ çš„ URL
    let cloudData = { records: [], items: [], sites: [] };
    let currentMode = 'in';
    let activeItem = "";

    // æ—¥æœŸæ ¼å¼åŒ–: YYYY/MM/DD HH:MM
    function formatDateTime(dateStr) {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        const pad = (n) => n.toString().padStart(2, '0');
        return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    async function fetchData() {
        showLoader(true);
        try {
            const res = await fetch(SCRIPT_URL);
            cloudData = await res.json();
            renderSettings();
            renderInventory();
        } catch(e) { console.error(e); alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–éƒ¨ç½²è¨­å®š"); }
        showLoader(false);
    }

    // åˆ‡æ›é€²å‡ºè²¨æ¨¡å¼
    function switchMode(mode) {
        currentMode = mode;
        const card = document.getElementById('formCard');
        const title = document.getElementById('formTitle');
        const btnIn = document.getElementById('btnIn');
        const btnOut = document.getElementById('btnOut');
        const priceInput = document.getElementById('price');
        const siteSelect = document.getElementById('siteSelect');

        if (mode === 'in') {
            card.className = "card p-3 form-inbound";
            title.innerText = "ğŸ“— å…¥åº«ç™»éŒ„";
            title.className = "fw-bold text-success";
            btnIn.className = "btn btn-success btn-sm w-50 me-1";
            btnOut.className = "btn btn-outline-danger btn-sm w-50";
            priceInput.disabled = false;
            siteSelect.innerHTML = `<option value="ç¸½å€‰">ç¸½å€‰ (å…¥åº«)</option> <option value="å…¬å¸å°å€‰">å…¬å¸å°å€‰ (å…¥åº«)</option>`;
        } else {
            card.className = "card p-3 form-outbound";
            title.innerText = "ğŸ“• å‡ºåº«ç™»éŒ„";
            title.className = "fw-bold text-danger";
            btnIn.className = "btn btn-outline-success btn-sm w-50 me-1";
            btnOut.className = "btn btn-danger btn-sm w-50";
            priceInput.disabled = true;
            siteSelect.innerHTML = cloudData.sites.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        updatePrice();
    }

    // è™•ç†å–®åƒ¹é¡¯ç¤º
    function updatePrice() {
        const selected = document.getElementById('itemSelect').value;
        const item = cloudData.items.find(i => i.name === selected);
        if (item) {
            document.getElementById('price').value = item.price;
            document.getElementById('priceHint').innerText = `ç³»çµ±ç´€éŒ„å–®åƒ¹: $${item.price}`;
        }
    }

    // æ¸²æŸ“åº«å­˜è¡¨ (å«æœå°‹èˆ‡ç´…ç‡ˆè­¦ç¤º)
    function renderInventory() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const inv = {};
        
        cloudData.records.forEach(r => {
            const [date, name, qty, price, loc] = r;
            if (!inv[name]) inv[name] = { in: 0, out: 0, p: price };
            if (qty > 0) { inv[name].in += qty; inv[name].p = price; }
            else { inv[name].out += Math.abs(qty); }
        });

        const rows = Object.keys(inv).filter(n => n.toLowerCase().includes(search)).map(name => {
            const s = inv[name];
            const bal = s.in - s.out;
            const isLow = bal < 30; // åº«å­˜è­¦ç¤ºé‚è¼¯
            return `<tr class="${isLow ? 'low-stock' : ''}">
                <td>${name} ${isLow ? 'âš ï¸' : ''}</td>
                <td>${s.in}</td><td>${s.out}</td>
                <td class="${isLow ? 'text-danger' : ''}">${bal}</td>
                <td>$${s.p}</td>
                <td><button class="btn btn-primary btn-xs" onclick="showDetail('${name}')">æ˜ç´°</button></td>
            </tr>`;
        }).join('');
        
        document.getElementById('inventoryBody').innerHTML = rows || '<tr><td colspan="6" class="text-center text-muted">ç„¡è³‡æ–™</td></tr>';
    }

    // æ¸²æŸ“è¨­å®šèˆ‡å ±è¡¨ä¸‹æ‹‰é¸å–®
    function renderSettings() {
        document.getElementById('itemSelect').innerHTML = cloudData.items.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
        // æ¸²æŸ“å…©å€‹åœ°æ–¹çš„æ¡ˆå ´ä¸‹æ‹‰ï¼šå ±è¡¨ç”¨ + åˆªé™¤ç”¨
        const siteOptions = cloudData.sites.map(s => `<option value="${s}">${s}</option>`).join('');
        document.getElementById('exportSite').innerHTML = `<option value="" disabled selected>-- è«‹é¸æ“‡æ¡ˆå ´ --</option>` + siteOptions;
        
        document.getElementById('itemList').innerHTML = cloudData.items.map(i => `<li class="list-group-item d-flex justify-content-between align-items-center">${i.name} ($${i.price}) <button class="btn btn-link text-danger p-0" onclick="manageBasicData('Items','delete','','${i.name}')">ğŸ—‘ï¸</button></li>`).join('');
        document.getElementById('siteList').innerHTML = cloudData.sites.map(s => `<li class="list-group-item d-flex justify-content-between align-items-center">${s} <button class="btn btn-link text-danger p-0" onclick="manageBasicData('Sites','delete','','${s}')">ğŸ—‘ï¸</button></li>`).join('');
        
        switchMode(currentMode);
    }

    // ã€æ–°åŠŸèƒ½ã€‘å³æ™‚æ¸²æŸ“æ¡ˆå ´å ±è¡¨é è¦½
    function renderSiteReport() {
        const site = document.getElementById('exportSite').value;
        if (!site) return;

        const filtered = cloudData.records.filter(r => r[4] === site);
        const total = filtered.reduce((sum, r) => sum + (Math.abs(r[2]) * r[3]), 0);

        document.getElementById('reportSummary').innerText = `${site} - ç¸½ç´¯è¨ˆé‡‘é¡: $${total.toLocaleString()}`;
        document.getElementById('reportPreviewBody').innerHTML = filtered.map(r => `
            <tr>
                <td>${formatDateTime(r[0])}</td>
                <td>${r[1]}</td>
                <td>${Math.abs(r[2])}</td>
                <td>$${r[3]}</td>
                <td>$${(Math.abs(r[2]) * r[3]).toLocaleString()}</td>
            </tr>
        `).join('');
    }

    // åŒ¯å‡º Excel (æ¡ˆå ´å ±è¡¨)
    function exportExcel() {
        const site = document.getElementById('exportSite').value;
        if (!site) { alert("è«‹å…ˆé¸æ“‡æ¡ˆå ´ï¼"); return; }
        
        const filtered = cloudData.records.filter(r => r[4] === site);
        const total = filtered.reduce((sum, r) => sum + (Math.abs(r[2]) * r[3]), 0);
        
        const wsData = [
            ["æ¡ˆå ´æœˆå ±è¡¨", "", "", "", ""],
            ["æ¡ˆå ´åç¨±:", site, "", "å°å‡ºæ™‚é–“:", formatDateTime(new Date())],
            [],
            ["æ—¥æœŸ", "å“é …", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]
        ];
        filtered.forEach(r => wsData.push([formatDateTime(r[0]), r[1], Math.abs(r[2]), r[3], Math.abs(r[2]) * r[3]]));
        wsData.push([]);
        wsData.push(["", "", "", "ç¸½è¨ˆ:", total]);

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, `${site}_è²»ç”¨å ±è¡¨.xlsx`);
    }

    // åŒ¯å‡º Excel (å–®å“æ˜ç´°)
    function exportSingleItemExcel() {
        const filtered = cloudData.records.filter(r => r[1] === activeItem);
        const wsData = [["æ—¥æœŸ", "å‹•ä½œ", "æ•¸é‡", "å–®åƒ¹", "æ¡ˆå ´"]];
        filtered.forEach(r => wsData.push([formatDateTime(r[0]), r[2]>0?"å…¥åº«":"å‡ºåº«", Math.abs(r[2]), r[3], r[4]]));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), "æ˜ç´°");
        XLSX.writeFile(wb, `${activeItem}_æ˜ç´°.xlsx`);
    }

    // é¡¯ç¤ºæ˜ç´°å½ˆçª—
    function showDetail(name) {
        activeItem = name;
        const filtered = cloudData.records.filter(r => r[1] === name);
        document.getElementById('modalTitle').innerText = `ã€${name}ã€‘é€²å‡ºæ˜ç´°`;
        document.getElementById('detailBody').innerHTML = filtered.map(r => `
            <tr>
                <td>${formatDateTime(r[0])}</td>
                <td>${r[2]>0 ? '<span class="badge bg-success">é€²</span>':'<span class="badge bg-danger">å‡º</span>'}</td>
                <td>${Math.abs(r[2])}</td>
                <td>$${r[3]}</td>
                <td>${r[4]}</td>
            </tr>
        `).reverse().join('');
        new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    // è³‡æ–™å¢åˆª
    async function manageBasicData(target, action, inputId, idVal) {
        const val = idVal || document.getElementById(inputId).value;
        if (!val) return;
        showLoader(true);
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ target: target, action: action, data: [val], id: val }) });
        if (inputId) document.getElementById(inputId).value = '';
        await fetchData();
    }

    // è¡¨å–®æäº¤
    document.getElementById('wmsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoader(true);
        let q = parseInt(document.getElementById('qty').value);
        if (currentMode === 'out') q = -Math.abs(q);
        const data = [
            document.getElementById('datetime').value.replace('T', ' '), 
            document.getElementById('itemSelect').value, 
            q, parseFloat(document.getElementById('price').value), 
            document.getElementById('siteSelect').value
        ];
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ target: 'Records', action: 'add', data: data }) });
        e.target.reset(); initTime();
        await fetchData();
    });

    function initTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('datetime').value = now.toISOString().slice(0, 16);
    }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    
    initTime();
    fetchData();
</script>
</body>
</html>

