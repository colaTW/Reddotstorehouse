<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿å¾·è³‡è¨Šå°ˆæ¥­å€‰å„²ç³»çµ± v4.0 - è‡ªå‹•å–®åƒ¹ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Microsoft JhengHei", sans-serif; }
        .nav-header { background: #2c3e50; color: white; padding: 15px 0; }
        .card { border-radius: 12px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .low-stock { background-color: #fff1f0 !important; color: #cf1322; font-weight: bold; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:9999; }
        .price-info { font-size: 0.8rem; color: #666; margin-top: 4px; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay"><div class="spinner-border text-primary"></div></div>

<div class="nav-header">
    <div class="container d-flex justify-content-between align-items-center">
        <h4 class="m-0">ğŸ“¦ é›²ç«¯å€‰å„²ç®¡ç† (è‡ªå‹•è¨ˆç®—æˆæœ¬)</h4>
        <button class="btn btn-outline-light btn-sm" onclick="fetchData()">ğŸ”„ åŒæ­¥è³‡æ–™</button>
    </div>
</div>

<div class="container mt-4">
    <ul class="nav nav-pills mb-3">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab1">é€²å‡ºè²¨ä½œæ¥­</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab2">åŸºç¤è³‡æ–™ç®¡ç†</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab3">æ¡ˆå ´å ±è¡¨åŒ¯å‡º</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab1">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3">
                        <h6 class="fw-bold mb-3">ğŸ–Šï¸ ç•°å‹•ç™»éŒ„</h6>
                        <form id="wmsForm">
                            <div class="mb-2 small">æ—¥æœŸ<input type="date" id="date" class="form-control form-control-sm" required></div>
                            <div class="mb-2 small">æ•¸é‡ (å…¥åº«æ­£æ•¸/å‡ºåº«è² æ•¸)
                                <input type="number" id="qty" class="form-control form-control-sm" required oninput="handleFormLogic()">
                            </div>
                            <div class="mb-2 small">å“é …
                                <select id="itemSelect" class="form-select form-select-sm" required onchange="handleFormLogic()"></select>
                            </div>
                            <div class="mb-2 small">å–®åƒ¹ 
                                <input type="number" id="price" class="form-control form-control-sm" required>
                                <div id="priceHint" class="price-info"></div>
                            </div>
                            <div class="mb-2 small">æ¡ˆå ´
                                <select id="siteSelect" class="form-select form-select-sm"></select>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">ç¢ºèªæäº¤</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-3">
                        <h6 class="fw-bold mb-3">ğŸ“ ç›®å‰å‰©é¤˜åº«å­˜ (ä½æ–¼ 30 ç´…ç‡ˆ)</h6>
                        <table class="table table-sm table-hover border small">
                            <thead class="table-light"><tr><th>å“é …</th><th>ç´¯è¨ˆé€²</th><th>ç´¯è¨ˆå‡º</th><th>å‰©é¤˜</th><th>ç›®å‰å–®åƒ¹</th><th>åº«å­˜åƒ¹å€¼</th></tr></thead>
                            <tbody id="inventoryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab2">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-3">
                        <h6>ğŸ› ï¸ å“é …æ¸…å–® (è¨­å®šå¾Œæ‰èƒ½é¸å–)</h6>
                        <div class="input-group mb-2">
                            <input type="text" id="newItem" class="form-control form-control-sm" placeholder="æ–°ç·¨è™Ÿ/å“å">
                            <button class="btn btn-dark btn-sm" onclick="manageBasicData('Items', 'add', 'newItem')">æ–°å¢</button>
                        </div>
                        <ul id="itemList" class="list-group list-group-flush small"></ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-3">
                        <h6>ğŸ› ï¸ æ¡ˆå ´æ¸…å–® (å‡ºè²¨ç”¨)</h6>
                        <div class="input-group mb-2">
                            <input type="text" id="newSite" class="form-control form-control-sm" placeholder="æ¡ˆå ´åç¨±">
                            <button class="btn btn-dark btn-sm" onclick="manageBasicData('Sites', 'add', 'newSite')">æ–°å¢</button>
                        </div>
                        <ul id="siteList" class="list-group list-group-flush small"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab3">
            <div class="card p-4 text-center">
                <h6>ğŸ“Š æ¡ˆå ´å‡ºè²¨åƒ¹å€¼æœˆå ± (Excel)</h6>
                <div class="row g-2 justify-content-center mt-3">
                    <div class="col-md-6"><select id="exportSite" class="form-select"></select></div>
                    <div class="col-md-2"><button class="btn btn-success w-100" onclick="exportExcel()">åŒ¯å‡º</button></div>
                </div>
                <div id="siteTotalPreview" class="mt-4 fw-bold text-primary h5"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw_QTwCooaSukUJog1rirU92ufhsc105kRGHKIsCSUlhOCfcTbKZ41KLsVr9e1YKBqJ/exec"; 
    const LOW_STOCK_LIMIT = 30; // ğŸ‘ˆ æ§åˆ¶ç´…ç‡ˆæ•¸é‡
    let cloudData = { records: [], items: [], sites: [] };

    document.getElementById('date').valueAsDate = new Date();

    async function fetchData() {
        showLoader(true);
        const res = await fetch(SCRIPT_URL);
        cloudData = await res.json();
        renderSettings();
        renderInventory();
        showLoader(false);
    }

    // é—œéµé‚è¼¯ï¼šè™•ç†å–®åƒ¹èˆ‡æ¡ˆå ´çš„é–å®š
    function handleFormLogic() {
        const qty = parseInt(document.getElementById('qty').value) || 0;
        const selectedItemName = document.getElementById('itemSelect').value;
        const itemObj = cloudData.items.find(i => i.name === selectedItemName);
        const priceInput = document.getElementById('price');
        const siteSelect = document.getElementById('siteSelect');
        const priceHint = document.getElementById('priceHint');

        if (qty >= 0) { // å…¥åº«
            priceInput.disabled = false;
            priceHint.innerText = itemObj ? `ç›®å‰ç´€éŒ„å–®åƒ¹: $${itemObj.price}` : "";
            siteSelect.innerHTML = '<option value="ç¸½å€‰">ç¸½å€‰ (å…¥åº«)</option>';
            siteSelect.disabled = true;
        } else { // å‡ºè²¨
            priceInput.disabled = true;
            if (itemObj) {
                priceInput.value = itemObj.price;
                priceHint.innerText = "å‡ºåº«è‡ªå‹•å¸¶å…¥æœ€æ–°å…¥åº«å–®åƒ¹";
            }
            siteSelect.disabled = false;
            siteSelect.innerHTML = cloudData.sites.map(s => `<option value="${s}">${s}</option>`).join('');
        }
    }

    async function manageBasicData(target, action, inputId, idVal) {
        const val = idVal || document.getElementById(inputId)?.value;
        if (!val) return;
        showLoader(true);
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ target: target, action: action, data: [val, 0], id: val })
        });
        if(inputId) document.getElementById(inputId).value = '';
        await fetchData();
    }

    function renderSettings() {
        document.getElementById('itemSelect').innerHTML = cloudData.items.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
        document.getElementById('exportSite').innerHTML = cloudData.sites.map(s => `<option value="${s}">${s}</option>`).join('');
        document.getElementById('itemList').innerHTML = cloudData.items.map(i => `<li class="list-group-item d-flex justify-content-between">${i.name} ($${i.price}) <button class="btn btn-link btn-sm text-danger" onclick="manageBasicData('Items','delete','','${i.name}')">åˆªé™¤</button></li>`).join('');
        document.getElementById('siteList').innerHTML = cloudData.sites.map(s => `<li class="list-group-item d-flex justify-content-between">${s} <button class="btn btn-link btn-sm text-danger" onclick="manageBasicData('Sites','delete','','${s}')">åˆªé™¤</button></li>`).join('');
        handleFormLogic();
    }

    function renderInventory() {
        const inv = {};
        cloudData.records.forEach(r => {
            const [date, name, qty, price, loc] = r;
            if (!inv[name]) inv[name] = { in: 0, out: 0, currentPrice: price };
            if (qty > 0) {
                inv[name].in += qty;
                inv[name].currentPrice = price; // æ›´æ–°ç‚ºæœ€å¾Œä¸€æ¬¡å…¥åº«åƒ¹
            } else {
                inv[name].out += Math.abs(qty);
            }
        });

        document.getElementById('inventoryBody').innerHTML = Object.entries(inv).map(([name, s]) => {
            const bal = s.in - s.out;
            const isLow = bal < LOW_STOCK_LIMIT;
            return `<tr class="${isLow ? 'low-stock' : ''}">
                <td>${name} ${isLow ? 'âš ï¸' : ''}</td>
                <td>${s.in}</td><td>${s.out}</td><td>${bal}</td>
                <td>$${s.currentPrice}</td><td>$${(bal * s.currentPrice).toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    document.getElementById('wmsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoader(true);
        const data = [
            document.getElementById('date').value,
            document.getElementById('itemSelect').value,
            parseInt(document.getElementById('qty').value),
            parseFloat(document.getElementById('price').value),
            document.getElementById('siteSelect').value
        ];
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ target: 'Records', action: 'add', data: data }) });
        e.target.reset();
        document.getElementById('date').valueAsDate = new Date();
        await fetchData();
    });

    function exportExcel() {
        const site = document.getElementById('exportSite').value;
        const filtered = cloudData.records.filter(r => r[4] === site);
        
        // è¨ˆç®—ç¸½é¡
        const total = filtered.reduce((sum, r) => sum + (Math.abs(r[2]) * r[3]), 0);
        
        const wsData = [
            ["æ¡ˆå ´æœˆå ±è¡¨", "", "", "", ""],
            ["æ¡ˆå ´åç¨±:", site, "", "å°å‡ºæ—¥æœŸ:", new Date().toLocaleDateString()],
            [],
            ["æ—¥æœŸ", "å“é …", "æ•¸é‡", "å–®åƒ¹", "å°è¨ˆ"]
        ];

        filtered.forEach(r => {
            wsData.push([r[0], r[1], r[2], r[3], Math.abs(r[2]) * r[3]]);
        });

        wsData.push([]);
        wsData.push(["", "", "", "æ¡ˆå ´å‡ºè²¨ç¸½åƒ¹å€¼:", total]);

        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");
        XLSX.writeFile(wb, `${site}_æ¡ˆå ´æœˆå ±.xlsx`);
        
        document.getElementById('siteTotalPreview').innerText = `${site} ç¸½ç´¯ç©é‡‘é¡: $${total.toLocaleString()}`;
    }

    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    fetchData();
</script>
</body>
</html>
